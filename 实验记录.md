## 2026-02-13

### 变更主题
- 调整 `best checkpoint` 选择逻辑：改为“标准化加权打分 + AUC 守门 + `val_loss` tie-break”。

### 代码与配置修改
- 修改 `configs/defaults.yaml`：
  - 新增 `eval.best_checkpoint` 配置块。
  - `z_dice_weight: 0.4`（默认 `z_wsi_auc_weight` 自动为 `0.6`）。
  - `auc_gate_delta: 0.002`。
  - `score_tie_eps: 1e-4`。
  - `std_eps: 1e-8`。
  - `loss_tie_eps: 1e-8`。

- 修改 `src/engine/train.py`：
  - 新增 `running_mean_std` 与 `safe_zscore`。
  - 训练初始化阶段读取 `eval.best_checkpoint` 配置并初始化：
    - `best_score`
    - `best_val_loss`
    - `best_wsi_auc`
  - 每个 epoch 的 best 判定改为：
    - 先计算 `z_dice` 与 `z_wsi_auc`；
    - `score = 0.4 * z_dice + 0.6 * z_wsi_auc`；
    - AUC 守门：`val_wsi_auc >= best_wsi_auc - 0.002` 才允许更新；
    - 若 `score` 接近（`|score - best_score| <= score_tie_eps`），用更低 `val_loss` 作为 tie-break。
  - 兼容回退逻辑：
    - 当 `val_wsi_auc` 不可用时，回退到原有均值评分（基于可用任务指标），避免训练中断。
  - `best.pt` 与 `best_checkpoint.txt` 追加记录：
    - `score_mode`
    - `z_dice_weight / z_wsi_auc_weight`
    - `auc_gate_delta`
    - `z_dice / z_wsi_auc`
    - `best_val_loss / best_wsi_auc`

### 本次本地校验
- `ruff check src/engine/train.py --select E9,F`：通过。
- `python -m compileall src/engine/train.py`：通过。
- `OmegaConf.load('configs/defaults.yaml')`：通过（成功读取 `best_checkpoint` 新配置）。
