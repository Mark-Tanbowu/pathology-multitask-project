# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# â†‘ è®© VS Code è¯†åˆ« GitHub Actions è¯­æ³•ï¼Œæ¶ˆé™¤â€œæœªè§£æçš„æ“ä½œ/å‚æ•°å¼•ç”¨â€è­¦å‘Š

name: CI Pipeline  # å·¥ä½œæµåç§°ï¼Œå‡ºç°åœ¨ GitHub Actions ç•Œé¢ä¸Š

on:
  push:            # å½“æœ‰ push æˆ– PR æ—¶è§¦å‘
  pull_request:

jobs:
  build:           # ä¸» Job åç§°ï¼ˆå¯æ”¹ä¸º lint-test-train ç­‰æ›´è¯­ä¹‰åŒ–çš„åå­—ï¼‰
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒï¼Œå¯æ”¹ä¸º windows-latest æµ‹è¯•å…¼å®¹æ€§

    steps:
      # -----------------------------------------------------
      # ğŸ§± 1ï¸âƒ£ æ£€å‡ºä»“åº“ä»£ç 
      # -----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # ğŸ 2ï¸âƒ£ è®¾ç½® Python ç¯å¢ƒå¹¶å¯ç”¨ pip ç¼“å­˜
      # cache: 'pip' ä¼šæ ¹æ® requirements.txt å“ˆå¸Œå€¼ç¼“å­˜ä¾èµ–åŒ…
      # -----------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # -----------------------------------------------------
      # ğŸ“¦ 3ï¸âƒ£ å®‰è£…é¡¹ç›®ä¾èµ–
      # pip ç¼“å­˜ä¼šä½¿è¿™ä¸€éƒ¨åˆ†æ˜¾è‘—æé€Ÿ
      # -----------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # -----------------------------------------------------
      # ğŸ” 4ï¸âƒ£ è¿è¡Œ pre-commitï¼ˆç»Ÿä¸€ä»£ç é£æ ¼æ£€æŸ¥ï¼‰
      # ä¼šè‡ªåŠ¨æ‰§è¡Œ black, isort, ruff, mypy ç­‰é’©å­
      # -----------------------------------------------------
#      - name: Run pre-commit hooks
#       uses: pre-commit/action@v3.0.1

      # -----------------------------------------------------
      # ğŸ§ª 5ï¸âƒ£ è¿è¡Œå•å…ƒæµ‹è¯•
      # pytest -q æ¨¡å¼é™é»˜è¾“å‡ºï¼Œåªæ˜¾ç¤ºç®€æ´ç»“æœ
      # -----------------------------------------------------
      - name: Run tests
        run: |
          python -m pytest -q

      # -----------------------------------------------------
      # ğŸš€ 6ï¸âƒ£ å†’çƒŸæ¨ç†ï¼ˆå¿«é€ŸéªŒè¯æ¨ç†è„šæœ¬æ˜¯å¦èƒ½è¿è¡Œï¼‰
      # è¿™ä¸€æ­¥ä¸éœ€è¦ GPUï¼Œä»… dry_run æµ‹è¯•åŠ è½½é€»è¾‘
      # -----------------------------------------------------
      - name: Smoke inference
        run: |
          python -m src.engine.infer --dry_run 1

      # -----------------------------------------------------
      # ğŸ”¥ 7ï¸âƒ£ å†’çƒŸè®­ç»ƒï¼ˆ1 epoch çš„å¿«é€Ÿè®­ç»ƒï¼‰
      # é€šè¿‡ Hydra å‚æ•°è¦†ç›–è®¾ç½®çŸ­è®­ç»ƒï¼ŒéªŒè¯æ¨¡å‹èƒ½è·‘é€š
      # -----------------------------------------------------
#      - name: Smoke train (1 epoch sanity check)
#        run: |
#          python -m src.engine.train num_epochs=1 batch_size=2 num_workers=0 device=cpu

      # -----------------------------------------------------
      # ğŸ“¤ 8ï¸âƒ£ ä¸Šä¼ æ—¥å¿—ä¸ Hydra é…ç½®æ–‡ä»¶ä½œä¸ºæ„å»ºäº§ç‰©
      # ä¾¿äºè°ƒè¯•ã€å¤ç°å®éªŒç¯å¢ƒ
      # -----------------------------------------------------
      - name: Upload logs and configs
        if: always()   # å³ä½¿å‰é¢æ­¥éª¤å¤±è´¥ä¹Ÿä¼šæ‰§è¡Œ
        uses: actions/upload-artifact@v4
        with:
          name: ci-outputs
          path: |
            outputs/**/*.log
            outputs/**/.hydra/*
            outputs/**/metrics.json
