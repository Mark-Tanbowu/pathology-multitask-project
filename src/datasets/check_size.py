from PIL import Image
import os

"""
============================================================
æ•°æ®é›†å®Œæ•´æ€§ä¸å°ºå¯¸ä¸€è‡´æ€§æ£€æŸ¥å·¥å…· (check_size.py)
------------------------------------------------------------
åŠŸèƒ½æ¦‚è¿°ï¼š
æœ¬è„šæœ¬ç”¨äºå¯¹é¢„å¤„ç†åçš„ç—…ç†å›¾åƒæ•°æ®é›†è¿›è¡Œå®Œæ•´æ€§éªŒè¯ï¼Œ
æ£€æŸ¥å›¾åƒä¸æ©ç æ–‡ä»¶åœ¨å‘½åã€æ•°é‡ä¸å°ºå¯¸ä¸Šçš„ä¸€è‡´æ€§ï¼Œ
ä»¥é˜²æ­¢æ¨¡å‹è®­ç»ƒé˜¶æ®µå‡ºç°ç»´åº¦ä¸åŒ¹é…æˆ–æ ·æœ¬ç¼ºå¤±é—®é¢˜ã€‚

ä¸»è¦åŠŸèƒ½ï¼š
1. è‡ªåŠ¨æ‰«ææŒ‡å®šæ•°æ®é›†åˆ’åˆ†ï¼ˆtrain / valï¼‰çš„å›ºå®šç›®å½•ï¼š
   - å›¾åƒç›®å½•: data/<split>/images_fixed/
   - æ©ç ç›®å½•: data/<split>/masks_fixed/
2. æ£€æŸ¥å†…å®¹åŒ…æ‹¬ï¼š
   - å›¾åƒæ–‡ä»¶æ˜¯å¦å­˜åœ¨å¯¹åº”çš„æ©ç æ–‡ä»¶
   - å›¾åƒä¸æ©ç çš„å°ºå¯¸æ˜¯å¦ä¸€è‡´
   - è¾“å‡ºç¼ºå¤±æ–‡ä»¶å’Œå¼‚å¸¸å°ºå¯¸çš„è¯¦ç»†ä¿¡æ¯
3. æ±‡æ€»æ£€æµ‹ç»“æœï¼š
   - å›¾åƒæ€»æ•°ã€ç¼ºå¤±æ•°é‡ã€ä¸ä¸€è‡´æ•°é‡ç»Ÿè®¡
   - æ¯å¼ å›¾åƒæ£€æŸ¥ç»“æœå³æ—¶æ‰“å°

ä½¿ç”¨è¯´æ˜ï¼š
------------------------------------------------------------
è¿è¡Œæ–¹å¼ï¼š
    python tools/dataset_checker.py

å¯é€‰å‚æ•°ï¼š
    - `split_name`ï¼šæ•°æ®é›†åˆ’åˆ†åï¼ˆé»˜è®¤æ£€æŸ¥ train å’Œ valï¼‰
      è‹¥éœ€è¦æ£€æŸ¥ testï¼Œå¯è‡ªè¡Œè°ƒç”¨ check_size("test")

è¾“å‡ºå†…å®¹ï¼š
    - æ¯å¼ å›¾åƒä¸æ©ç çš„åŒ¹é…çŠ¶æ€
    - å°ºå¯¸ä¸ä¸€è‡´æˆ–ç¼ºå¤±æ–‡ä»¶æç¤º
    - æ¯ä¸ªæ•°æ®é›†çš„æ±‡æ€»ç»Ÿè®¡æŠ¥å‘Š

æ³¨æ„äº‹é¡¹ï¼š
------------------------------------------------------------
1. æœ¬è„šæœ¬å‡å®šæ•°æ®å·²é€šè¿‡ fix_size.py é¢„å¤„ç†ï¼Œ
   å³å›¾åƒä¸æ©ç å­˜æ”¾åœ¨ *_fixed ç›®å½•ä¸­ã€‚
2. æ©ç å‘½ååº”éµå¾ª `_anno.bmp` è§„åˆ™ã€‚
3. è‹¥æ£€æµ‹å‡ºå°ºå¯¸ä¸ä¸€è‡´ï¼Œè¯·é‡æ–°è¿è¡Œé‡é‡‡æ ·è„šæœ¬è¿›è¡Œä¿®å¤ã€‚
4. è‹¥ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©ºï¼Œè„šæœ¬ä¼šè‡ªåŠ¨è·³è¿‡è¯¥æ•°æ®é›†å¹¶ç»™å‡ºæç¤ºã€‚

é€‚ç”¨åœºæ™¯ï¼š
------------------------------------------------------------
æœ¬å·¥å…·ç”¨äºæ•°å­—ç—…ç†å›¾åƒé¡¹ç›®çš„æ•°æ®è´¨é‡æ§åˆ¶é˜¶æ®µï¼Œ
å¸®åŠ©ç ”ç©¶è€…å¿«é€ŸéªŒè¯æ•°æ®å‡†å¤‡æ˜¯å¦å®Œæ•´ã€è§„èŒƒï¼Œ
ä»¥ç¡®ä¿åç»­è®­ç»ƒï¼ˆtrain.pyï¼‰é˜¶æ®µç¨³å®šè¿è¡Œã€‚

============================================================
"""

def check_dataset(split_name):
    img_dir = f"data/{split_name}/images_fixed"
    mask_dir = f"data/{split_name}/masks_fixed"

    print(f"\nğŸ” å¼€å§‹æ£€æŸ¥ {split_name} é›†...")
    if not os.path.exists(img_dir) or not os.path.exists(mask_dir):
        print(f"âŒ {split_name} é›†ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡ã€‚")
        return

    total = 0
    inconsistent = 0
    missing = 0

    for fname in sorted(os.listdir(img_dir)):
        if not fname.endswith(".bmp"):
            continue

        total += 1
        img_path = os.path.join(img_dir, fname)
        mask_name = fname.replace(".bmp", "_anno.bmp")
        mask_path = os.path.join(mask_dir, mask_name)

        if not os.path.exists(mask_path):
            print(f"âŒ ç¼ºå°‘ mask æ–‡ä»¶: {mask_name}")
            missing += 1
            continue

        img = Image.open(img_path)
        mask = Image.open(mask_path)

        if img.size != mask.size:
            print(f"âš ï¸ å°ºå¯¸ä¸ä¸€è‡´: {fname}")
            print(f"   å›¾åƒå°ºå¯¸ = {img.size}, mask å°ºå¯¸ = {mask.size}")
            inconsistent += 1
        else:
            print(f"âœ… ä¸€è‡´: {fname} ({img.size})")

    print(f"\nğŸ“Š {split_name} é›†æ£€æµ‹å®Œæˆï¼šå…± {total} å¼ å›¾åƒï¼Œ"
          f"ç¼ºå°‘ {missing}ï¼Œå°ºå¯¸ä¸ä¸€è‡´ {inconsistent}ã€‚\n")


if __name__ == "__main__":
    check_dataset("train")
    check_dataset("val")
    print("ğŸ¯ å…¨éƒ¨æ£€æµ‹å®Œæˆï¼")
